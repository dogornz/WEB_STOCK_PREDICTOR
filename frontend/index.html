<!doctype html>
<html lang="vi">

<head>
  <meta charset="utf-8" />
  <title>Stock Predictor Vertical</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/luxon@^3"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@^1"></script>

  <style>
    body {
      background: #071920;
      color: #d7fff6;
      font-family: Inter, Arial;
      padding: 18px;
    }

    h1 {
      color: #16c3b7;
      text-align: center;
      margin-bottom: 10px;
    }

    .controls {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin-bottom: 14px;
    }

    select,
    button {
      padding: 8px 12px;
      border-radius: 5px;
      border: none;
    }

    button {
      background: #16c3b7;
      color: #002b28;
      font-weight: 600;
      cursor: pointer;
    }

    #chart-container {
      width: 800px;
      height: 1000px;
      margin: auto;
      background: #0e1a28;
      border-radius: 12px;
      padding: 10px;
    }

    .info {
      width: 800px;
      margin: auto;
      display: flex;
      justify-content: space-between;
      gap: 12px;
      color: #cfeeea;
      margin-bottom: 8px;
    }

    .info div {
      background: rgba(255, 255, 255, 0.02);
      padding: 8px 12px;
      border-radius: 8px;
      min-width: 160px;
      text-align: center;
    }

    .info .label {
      font-size: 12px;
      color: #9ad6cc;
    }

    .info .value {
      font-size: 18px;
      font-weight: 700;
      color: #e6fff9;
    }
  </style>
</head>

<body>
  <h1>ðŸ“Š Stock Predictor (Vertical Chart)</h1>

  <div class="controls">
    <select id="ticker">
      <option>VIC.VN</option>
      <option>VCB.VN</option>
      <option>VHM.VN</option>
    </select>
    <button id="btn">Load & Predict</button>
  </div>

  <!-- Info panel: current price and predicted price -->
  <div class="info" id="info-panel" style="display:none">
    <div>
      <div class="label">Signal</div>
      <div class="value" id="signal">-</div>
    </div>
    <div>
      <div class="label">Current Close</div>
      <div class="value" id="current-price">-</div>
    </div>
    <div>
      <div class="label">Predicted Return (tomorrow)</div>
      <div class="value" id="predicted-return">-</div>
    </div>
    <div>
      <div class="label">Predicted Price (tomorrow)</div>
      <div class="value" id="predicted-price">-</div>
    </div>
    <div>
      <div class="label">Probability (buy)</div>
      <div class="value" id="probability">-</div>
    </div>
  </div>

  <div id="chart-container">
    <canvas id="chart"></canvas>
  </div>

  <script>
    const API = "http://127.0.0.1:8000/predict";
    let chart;

    document.getElementById("btn").addEventListener("click", loadAndPlot);

    async function loadAndPlot() {
      const ticker = document.getElementById("ticker").value;
      const res = await fetch(`${API}?ticker=${ticker}&n=200`);
      const json = await res.json();

      // show info panel if available
      const infoPanel = document.getElementById('info-panel');
      if (json.error) {
        infoPanel.style.display = 'none';
        alert(json.error);
        return;
      }

      // Populate info values safely
      const currentPrice = json.current_price ?? null;
      const predictedPrice = json.predicted_price_tomorrow ?? null;
      const predictedReturn = json.predicted_return_tomorrow ?? null;
      const probability = json.probability ?? null;
      const signal = json.signal ?? '-';

      document.getElementById('signal').textContent = signal;
      document.getElementById('current-price').textContent = currentPrice !== null ? currentPrice.toFixed(2) : '-';
      document.getElementById('predicted-return').textContent = predictedReturn !== null ? (predictedReturn * 100).toFixed(2) + '%' : '-';
      document.getElementById('predicted-price').textContent = predictedPrice !== null ? predictedPrice.toFixed(2) : '-';
      document.getElementById('probability').textContent = probability !== null ? (probability * 100).toFixed(1) + '%' : '-';
      infoPanel.style.display = 'flex';

      const rows = json.data.map(r => ({
        t: new Date(r.Date),
        o: r.Open, h: r.High, l: r.Low, c: r.Close
      }));

      // Close prices for wave
      const closes = rows.map(r => r.c);
      const labels = rows.map(r => r.t);

      // Arrow markers
      const arrows = rows.map((r, i) => {
        if (i === 0) return null;
        const prev = rows[i - 1].c;
        const diff = r.c - prev;
        return {
          x: r.c,
          y: r.t,
          direction: diff > 0 ? "up" : "down"
        };
      }).filter(Boolean);

      if (chart) chart.destroy();

      const ctx = document.getElementById("chart").getContext("2d");
      chart = new Chart(ctx, {
        type: "line",
        data: {
          labels: labels,
          datasets: [
            {
              label: `${ticker} Close`,
              data: closes,
              borderColor: "#16c3b7",
              tension: 0.3,
              pointRadius: 0
            },
            {
              label: "Arrows",
              data: closes,
              borderColor: "transparent",
              pointStyle: arrows.map(a => a.direction === "up" ? "triangle" : "rectRot"),
              pointRotation: arrows.map(a => a.direction === "up" ? 0 : 180),
              pointRadius: 8,
              backgroundColor: arrows.map(a => a.direction === "up" ? "#00e676" : "#ff1744")
            }
          ]
        },
        options: {
          indexAxis: "x", // thá»i gian theo trá»¥c dá»c
          plugins: {
            legend: { labels: { color: "#d7fff6" } },
            tooltip: {
              callbacks: {
                label: (ctx) => `Close: ${ctx.raw}`
              }
            }
          },
          scales: {
            y: {
              ticks: { color: "#cfeeea" },
              grid: { color: "rgba(255,255,255,0.05)" }
            },
            x: {
              type: "time",
              time: { unit: "day" },
              ticks: { color: "#cfeeea" },
              grid: { color: "rgba(255,255,255,0.05)" }
            }
          }
        }
      });
    }
  </script>
</body>

</html>